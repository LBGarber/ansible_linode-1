- name: firewall_basic
  block:
    - name: Create a Linode LKE cluster
      linode.cloud.lke_cluster:
        api_token: '{{ api_token }}'
        label: 'ansible-test-{{ ansible_date_time.epoch }}'
        region: us-southeast
        k8s_version: 1.22
        node_pools:
          - type: g6-standard-1
            count: 3
          - type: g6-standard-4
            count: 1
        wait_for_ready: true
        state: present
      register: create_cluster

    - assert:
        that:
          - create_cluster.cluster.k8s_version == '1.22'
          - create_cluster.cluster.region == 'us-southeast'
          - create_cluster.node_pools[0].type == 'g6-standard-1'
          - create_cluster.node_pools[0].count == 3

    - name: Update the cluster's node pools
      linode.cloud.lke_cluster:
        api_token: '{{ api_token }}'
        label: '{{ create_cluster.cluster.label }}'
        region: us-southeast
        k8s_version: 1.22
        node_pools:
          - type: g6-standard-1
            count: 2
          - type: g6-standard-2
            count: 1
          - type: g6-standard-1
            count: 2
        state: present
      register: update_pools

    - assert:
        that:
          - update_pools.cluster.k8s_version == '1.22'
          - update_pools.cluster.region == 'us-southeast'

          - update_pools.node_pools | length == 3

          - update_pools.node_pools[0].type == 'g6-standard-1'
          - update_pools.node_pools[0].count == 2
          - update_pools.node_pools[0].id == create_cluster.node_pools[0].id

          - update_pools.node_pools[1].type == 'g6-standard-2'
          - update_pools.node_pools[1].count == 1
          - update_pools.node_pools[2].type == 'g6-standard-1'
          - update_pools.node_pools[2].count == 2

    - name: Upgrade the cluster
      linode.cloud.lke_cluster:
        api_token: '{{ api_token }}'
        label: '{{ create_cluster.cluster.label }}'
        region: us-southeast
        k8s_version: 1.23
        node_pools:
          - type: g6-standard-1
            count: 1
        state: present
      register: upgrade

    - assert:
        that:
          - upgrade.cluster.k8s_version == '1.23'
          - upgrade.cluster.region == 'us-southeast'

          - upgrade.node_pools | length == 1

          - upgrade.node_pools[0].type == 'g6-standard-1'
          - upgrade.node_pools[0].count == 1
          - upgrade.node_pools[0].id == create_cluster.node_pools[0].id
